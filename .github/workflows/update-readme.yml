name: Auto Update README

on:
  schedule:
    # Update timestamp daily at 6:00 AM IST (12:30 AM UTC)
    - cron: '30 0 * * *'
    
    # Update year on January 1st at midnight IST (6:30 PM UTC Dec 31)
    - cron: '30 18 31 12 *'
  
  # Allows manual trigger from Actions tab
  workflow_dispatch:
  
  # Runs on push to main (except README changes to prevent loops)
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.github/workflows/update-readme.yml'

# Set permissions for the GITHUB_TOKEN
permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update README
        run: |
          # Set timezone to India Standard Time
          export TZ='Asia/Kolkata'
          
          # Get current date, time, and year
          CURRENT_DATE=$(date '+%B %d, %Y at %H:%M IST')
          CURRENT_YEAR=$(date '+%Y')
          NEXT_YEAR=$((CURRENT_YEAR + 1))
          
          echo "üìÖ Current IST Time: $CURRENT_DATE"
          echo "üìÜ Current Year: $CURRENT_YEAR"
          echo "üìÜ Next Year: $NEXT_YEAR"
          
          # Check if it's January 1st (New Year)
          CURRENT_MONTH_DAY=$(date '+%m-%d')
          
          # Update timestamp
          echo "üîÑ Updating timestamp..."
          sed -i -E "s/(Last Updated:).*IST/\1 $CURRENT_DATE/g" README.md
          sed -i -E "s/(\*\*Last Updated:).*IST(\*\*)/\1 $CURRENT_DATE\2/g" README.md
          
          # Update year in goals section if it's New Year
          if [ "$CURRENT_MONTH_DAY" == "01-01" ]; then
            echo "üéâ Happy New Year! Updating year in goals section..."
            sed -i -E "s/## üéØ [0-9]{4} Goals/## üéØ $CURRENT_YEAR Goals/g" README.md
            echo "‚úÖ Year updated to $CURRENT_YEAR"
          else
            echo "‚ÑπÔ∏è Not New Year's Day, keeping current year"
          fi
          
          echo "‚úÖ README.md updated successfully!"
      
      - name: Commit and Push Changes
        run: |
          export TZ='Asia/Kolkata'
          
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add README.md
          
          if ! git diff --cached --quiet; then
            COMMIT_TIME=$(date '+%B %d, %Y at %H:%M IST')
            CURRENT_MONTH_DAY=$(date '+%m-%d')
            
            if [ "$CURRENT_MONTH_DAY" == "01-01" ]; then
              CURRENT_YEAR=$(date '+%Y')
              git commit -m "üéâ Happy New Year $CURRENT_YEAR! Auto-update timestamp and year [$COMMIT_TIME]"
            else
              git commit -m "ü§ñ Auto-update timestamp [$COMMIT_TIME]"
            fi
            
            git push origin main
            echo "‚úÖ Changes pushed successfully!"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi
