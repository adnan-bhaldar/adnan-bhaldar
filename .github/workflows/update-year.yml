name: Update Year in Goals

on:
  schedule:
    # Runs on January 1st at 12:05 AM IST (December 31st 6:35 PM UTC)
    - cron: '35 18 31 12 *'
  
  # Allows manual trigger
  workflow_dispatch:
  
  # Runs on push to main
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update-year:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Year in README
        run: |
          # Set timezone to IST
          export TZ='Asia/Kolkata'
          
          # Get current year from system
          CURRENT_SYSTEM_YEAR=$(date '+%Y')
          
          echo "üìÖ System Year: $CURRENT_SYSTEM_YEAR"
          
          # Find what year is currently in README (extracts the year from "## üéØ YYYY Goals")
          CURRENT_README_YEAR=$(grep -oP '## üéØ \K[0-9]{4}(?= Goals)' README.md 2>/dev/null || echo "")
          
          if [ -z "$CURRENT_README_YEAR" ]; then
            echo "‚ùå Could not find year in Goals section"
            exit 0
          fi
          
          echo "üìñ README currently shows: $CURRENT_README_YEAR Goals"
          
          # Update logic: If README year is different from system year, update it
          if [ "$CURRENT_README_YEAR" != "$CURRENT_SYSTEM_YEAR" ]; then
            echo "üîÑ Updating from $CURRENT_README_YEAR to $CURRENT_SYSTEM_YEAR"
            
            # Replace the year in the README
            sed -i "s/## üéØ ${CURRENT_README_YEAR} Goals/## üéØ ${CURRENT_SYSTEM_YEAR} Goals/g" README.md
            
            echo "‚úÖ Updated from $CURRENT_README_YEAR to $CURRENT_SYSTEM_YEAR!"
          else
            echo "‚úÖ README year already matches system year ($CURRENT_SYSTEM_YEAR). No update needed."
          fi
          
          # Show the goals section
          echo "üìã Current Goals section:"
          grep -A 6 "## üéØ" README.md
      
      - name: Commit and Push Changes
        run: |
          export TZ='Asia/Kolkata'
          
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add README.md
          
          if ! git diff --cached --quiet; then
            CURRENT_YEAR=$(date '+%Y')
            git commit -m "üéØ Update goals year to $CURRENT_YEAR [Auto-update]"
            git push origin main
            echo "‚úÖ Changes pushed successfully!"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi
